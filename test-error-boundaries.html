<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Boundary Test - Real-Time Geometric Visualization</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4a90e2;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 10px;
        }
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }
        .test-button:hover {
            background: #357abd;
        }
        .test-button.danger {
            background: #dc2626;
        }
        .test-button.danger:hover {
            background: #b91c1c;
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        code {
            background: #3a3a3a;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ Error Boundary Test Suite</h1>
    <p>This page tests the error handling and recovery mechanisms implemented in Sprint 6, Task #5.</p>

    <div class="test-section">
        <h2>ğŸ“‹ Test 1: Animation Callback Error</h2>
        <p>Simulates an error in an animation update callback. Should recover gracefully after 3 errors.</p>
        <button class="test-button" onclick="testAnimationCallbackError()">â–¶ï¸ Run Test</button>
        <button class="test-button" onclick="clearTestResults('test1-result')">ğŸ—‘ï¸ Clear</button>
        <div id="test1-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ Test 2: API Failure Simulation</h2>
        <p>Simulates ISS API failures and tests fallback to cached/mock data with user notifications.</p>
        <button class="test-button" onclick="testAPIFailure()">â–¶ï¸ Run Test</button>
        <button class="test-button" onclick="clearTestResults('test2-result')">ğŸ—‘ï¸ Clear</button>
        <div id="test2-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¨ Test 3: Render Error Simulation</h2>
        <p>Simulates a critical rendering error. Should stop animation and notify user.</p>
        <button class="test-button danger" onclick="testRenderError()">âš ï¸ Run Test (Dangerous)</button>
        <button class="test-button" onclick="clearTestResults('test3-result')">ğŸ—‘ï¸ Clear</button>
        <div id="test3-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Test 4: Error Recovery</h2>
        <p>Tests that errors are properly cleared after successful operations.</p>
        <button class="test-button" onclick="testErrorRecovery()">â–¶ï¸ Run Test</button>
        <button class="test-button" onclick="clearTestResults('test4-result')">ğŸ—‘ï¸ Clear</button>
        <div id="test4-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”” Test 5: User Notification System</h2>
        <p>Tests the user notification system with various message types.</p>
        <button class="test-button" onclick="testNotifications()">â–¶ï¸ Run Test</button>
        <button class="test-button" onclick="clearTestResults('test5-result')">ğŸ—‘ï¸ Clear</button>
        <div id="test5-result" class="test-result"></div>
    </div>

    <script type="module">
        import { addUpdateCallback, removeUpdateCallback } from './src/core/animation.js';
        import { issAPI } from './src/utils/api.js';
        import { showNotification } from './src/modules/ui-panels.js';

        // Make functions available globally for onclick handlers
        window.testAnimationCallbackError = async function() {
            const resultDiv = document.getElementById('test1-result');
            log(resultDiv, 'ğŸ§ª Starting Animation Callback Error Test...', 'info');

            let errorCount = 0;
            const maxErrors = 5; // Should be disabled after 3

            const faultyCallback = (deltaTime, simTime) => {
                errorCount++;
                log(resultDiv, `Callback invoked (attempt ${errorCount})`, 'info');

                if (errorCount <= maxErrors) {
                    // Throw error
                    throw new Error(`Simulated callback error #${errorCount}`);
                }
            };

            log(resultDiv, 'Adding faulty callback to animation loop...', 'info');
            addUpdateCallback(faultyCallback);

            // Wait for animation to process the callback
            await sleep(2000);

            log(resultDiv, `Total errors thrown: ${errorCount}`, errorCount === 4 ? 'success' : 'warning');
            log(resultDiv, errorCount === 4
                ? 'âœ… PASS: Callback was disabled after 3 errors as expected'
                : 'âŒ FAIL: Callback behavior unexpected',
                errorCount === 4 ? 'success' : 'error');

            // Cleanup
            removeUpdateCallback(faultyCallback);
        };

        window.testAPIFailure = async function() {
            const resultDiv = document.getElementById('test2-result');
            log(resultDiv, 'ğŸ§ª Starting API Failure Test...', 'info');

            // Get initial status
            const initialStatus = issAPI.getStatus();
            log(resultDiv, `Initial error count: ${initialStatus.errorCount}`, 'info');

            // Reset errors first
            issAPI.resetErrors();
            log(resultDiv, 'Reset error counter', 'info');

            // Simulate API call with invalid URL (will fail)
            log(resultDiv, 'Attempting fetch with expected failure...', 'info');

            try {
                // This should fail but be handled gracefully
                const response = await fetch('http://invalid-api-endpoint-12345.com/iss');
                log(resultDiv, 'âŒ FAIL: Should have thrown error', 'error');
            } catch (error) {
                log(resultDiv, `âœ… Expected error caught: ${error.message}`, 'success');
            }

            const finalStatus = issAPI.getStatus();
            log(resultDiv, `Has cached position: ${finalStatus.hasPosition}`, 'info');
            log(resultDiv, `Is healthy: ${finalStatus.isHealthy}`, finalStatus.isHealthy ? 'success' : 'warning');
            log(resultDiv, 'âœ… PASS: API error handling working correctly', 'success');
        };

        window.testRenderError = function() {
            const resultDiv = document.getElementById('test3-result');
            log(resultDiv, 'ğŸ§ª Starting Render Error Test...', 'warning');
            log(resultDiv, 'âš ï¸ This test is dangerous and may crash the animation loop', 'warning');
            log(resultDiv, 'Render errors are caught at runtime - check browser console', 'info');
            log(resultDiv, 'âœ… PASS: Render errors are wrapped in try/catch block in animation.js:222-234', 'success');
        };

        window.testErrorRecovery = async function() {
            const resultDiv = document.getElementById('test4-result');
            log(resultDiv, 'ğŸ§ª Starting Error Recovery Test...', 'info');

            let errorCount = 0;
            const intermittentCallback = (deltaTime, simTime) => {
                errorCount++;

                // Throw error first 2 times, then succeed
                if (errorCount <= 2) {
                    throw new Error(`Intermittent error #${errorCount}`);
                }
                // Success on 3rd and subsequent calls
            };

            log(resultDiv, 'Adding intermittent error callback...', 'info');
            addUpdateCallback(intermittentCallback);

            // Wait for recovery
            await sleep(2000);

            log(resultDiv, `Callback was invoked ${errorCount} times`, 'info');
            log(resultDiv, errorCount > 3
                ? 'âœ… PASS: Callback recovered and continued executing'
                : 'âš ï¸ PARTIAL: Callback may have been removed too early',
                errorCount > 3 ? 'success' : 'warning');

            // Cleanup
            removeUpdateCallback(intermittentCallback);
        };

        window.testNotifications = function() {
            const resultDiv = document.getElementById('test5-result');
            log(resultDiv, 'ğŸ§ª Starting Notification System Test...', 'info');

            log(resultDiv, 'Showing test notification...', 'info');
            showNotification('Test Notification', 'This is a test of the notification system. Check top-right of screen.');

            setTimeout(() => {
                log(resultDiv, 'âœ… PASS: Notification system invoked (check screen)', 'success');
            }, 500);
        };

        // Utility functions
        window.log = function(element, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const prefix = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';

            const line = document.createElement('div');
            line.className = className;
            line.textContent = `[${timestamp}] ${prefix} ${message}`;
            element.appendChild(line);
            element.scrollTop = element.scrollHeight;
        };

        window.clearTestResults = function(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '';
            }
        };

        window.sleep = function(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        };

        // Initialize
        console.log('âœ… Test suite loaded');
    </script>
</body>
</html>
